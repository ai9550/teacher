<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數學直式減法練習 - 限時挑戰</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none; /* 防止連點選取文字 */
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%);
            min-height: 100vh;
            margin: 0;
            padding: 10px; /* 減少 padding 讓版面更緊湊 */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* 靠上對齊 */
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 20px 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            margin-top: 20px; /* 稍微留點頭部空間 */
        }

        .header-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .title {
            text-align: center;
            color: rgb(51, 51, 51);
            font-size: 24px; /* 稍微縮小標題 */
            font-weight: bold;
            margin: 0;
        }

        /* 新增：資訊列容器 (時間、分數、下一題) */
        .status-bar {
            display: flex;
            flex-direction: row;
            justify-content: space-between; /* 平均分配 */
            align-items: center;
            width: 100%;
            background-color: #f0f4f8;
            padding: 8px 15px;
            border-radius: 12px;
            gap: 10px;
        }

        .timer-display {
            font-size: 16px;
            color: rgb(255, 107, 107);
            font-weight: bold;
            white-space: nowrap; /* 不換行 */
        }

        .score-display {
            font-size: 16px;
            color: rgb(76, 175, 80);
            font-weight: bold;
            white-space: nowrap;
        }

        /* 調整後的下一題按鈕樣式 */
        .next-btn-small {
            background: rgb(74, 144, 226);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: none; /* 初始隱藏 */
            white-space: nowrap;
        }
        .next-btn-small:hover { background: rgb(53, 122, 189); }

        .problem-container {
            background: rgb(248, 249, 255);
            border-radius: 15px;
            padding: 20px 10px; /* 減少左右 padding */
            margin-bottom: 10px;
            border: 2px solid rgb(225, 229, 242);
            position: relative;
        }

        /* 遮罩層 */
        .problem-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 13px;
            z-index: 10;
            font-size: 24px;
            font-weight: bold;
            color: #555;
            flex-direction: column;
            gap: 10px;
        }

        .calculation {
            font-size: 64px;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
            position: relative;
        }

        .row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            position: relative;
        }

        /* 對齊調整：兩排都向右推 80px，確保上下對齊 */
        .minuend-row { margin-left: 80px; }
        .subtrahend-row { margin-left: 80px; } /* 修正：這裡加入 margin-left */
        .answer-row { margin-left: 80px; }

        .digit-container {
            position: relative;
            margin: 0 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }

        .digit {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: rgb(51, 51, 51);
            position: relative;
            cursor: default;
        }

        .digit.interactive { cursor: pointer; }
        .digit.interactive:hover { background-color: rgba(0,0,0,0.02); border-radius: 50%; }

        .digit.borrowed { color: rgb(153, 153, 153); }
        .digit.borrowed::after {
            content: "";
            position: absolute;
            top: 50%; left: 10%; right: 10%;
            height: 3px;
            background: rgb(255, 107, 107);
            transform: rotate(-15deg);
        }

        .borrow-indicator {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            background: rgb(255, 107, 107); color: white; padding: 2px 8px;
            border-radius: 8px; font-size: 20px; font-weight: bold; display: none;
        }
        .borrow-indicator.show { display: block; }

        .borrowed-value {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            color: rgb(74, 144, 226); font-size: 28px; font-weight: bold; display: none;
        }
        .borrowed-value.show { display: block; }

        .minus-sign {
            font-size: 64px;
            color: rgb(51, 51, 51);
            position: absolute;
            /* 修正：將減號定位到左側，因為整個 row 向右移了，減號需要往左推出來 */
            left: -60px; 
            top: 50%;
            transform: translateY(-55%); /* 垂直置中微調 */
        }

        .line {
            width: 300px;
            height: 4px;
            background: rgb(51, 51, 51);
            margin: 10px auto;
        }

        .answer-box {
            width: 80px; height: 80px;
            border: 3px dashed rgb(74, 144, 226);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: bold; color: rgb(74, 144, 226);
            background: rgb(248, 249, 255);
            cursor: pointer; transition: 0.3s;
        }

        .answer-box:hover { background: rgb(232, 242, 255); border-color: rgb(33, 113, 181); }
        .answer-box.filled { background: rgb(74, 144, 226); color: white; border-style: solid; }
        .answer-box.correct-answer { background: rgb(76, 175, 80); border-color: rgb(76, 175, 80); color: white; border-style: solid; }
        .answer-box.wrong-answer { background: rgb(244, 67, 54); border-color: rgb(244, 67, 54); color: white; border-style: solid; }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        .btn {
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            width: 100%;
            max-width: 300px;
        }

        .start-btn { background: rgb(76, 175, 80); color: white; }
        .start-btn:hover { background: rgb(67, 160, 71); }

        .feedback {
            text-align: center;
            margin-top: 5px;
            font-size: 20px;
            font-weight: bold;
            height: 30px;
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: none; z-index: 999;
        }

        .number-picker {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: none; z-index: 1000;
        }

        .number-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;
        }

        .number-btn {
            width: 60px; height: 60px;
            border: 2px solid rgb(74, 144, 226); border-radius: 10px;
            background: white; font-size: 24px; font-weight: bold; color: rgb(74, 144, 226);
            cursor: pointer;
        }

        .number-btn:hover { background: rgb(74, 144, 226); color: white; }

        .close-picker-btn {
            width: 100%; padding: 10px; background: rgb(255, 107, 107);
            color: white; border: none; border-radius: 8px; cursor: pointer;
        }

        @media (max-width: 480px) {
            .calculation { font-size: 48px; }
            .digit, .answer-box { width: 50px; height: 50px; font-size: 28px; }
            .digit-container { width: 50px; }
            /* 手機版同步調整 Margin */
            .minuend-row, .subtrahend-row, .answer-row { margin-left: 50px; }
            .minus-sign { left: -40px; font-size: 48px; }
            .line { width: 200px; }
            .number-btn { width: 45px; height: 45px; }
            .status-bar { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

<main class="container">
    <div class="header-area">
        <h1 class="title">二位數直式減法練習</h1>
        <!-- 新的資訊列：整合時間、分數、下一題 -->
        <div class="status-bar">
            <div class="timer-display" id="timer">時間: 60秒</div>
            <div class="score-display" id="score">答對: 0</div>
            <button class="next-btn-small" id="nextBtn" onclick="nextQuestion()">下一題</button>
        </div>
    </div>

    <div class="problem-container">
        <div class="problem-mask" id="problemMask">
            <span>準備好了嗎？</span>
            <span style="font-size: 16px;">請按下開始計時</span>
        </div>

        <div class="calculation">
            <!-- 被減數 (上方) -->
            <div class="row minuend-row">
                <div class="digit-container">
                    <div class="borrowed-value" id="borrow-left-val"></div>
                    <div class="digit interactive" id="minuend-tens" onclick="toggleBorrow()"></div>
                </div>
                <div class="digit-container">
                    <div class="borrow-indicator" id="borrow-ones-indicator">10</div>
                    <div class="digit" id="minuend-ones"></div>
                </div>
            </div>

            <!-- 減數 (中間) - 已修正對齊 -->
            <div class="row subtrahend-row">
                <div class="minus-sign">−</div>
                <div class="digit-container">
                    <div class="digit" id="subtrahend-tens"></div>
                </div>
                <div class="digit-container">
                    <div class="digit" id="subtrahend-ones"></div>
                </div>
            </div>

            <div class="line"></div>

            <!-- 答案 (下方) -->
            <div class="row answer-row">
                <div class="digit-container">
                    <div class="answer-box" id="answer-tens" onclick="openPicker('tens')">?</div>
                </div>
                <div class="digit-container">
                    <div class="answer-box" id="answer-ones" onclick="openPicker('ones')">?</div>
                </div>
            </div>
        </div>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="controls">
        <button class="btn start-btn" id="startBtn" onclick="startGame()">開始計時 (1分鐘)</button>
    </div>
</main>

<!-- 數字鍵盤 Modal -->
<div class="overlay" id="overlay" onclick="closePicker()"></div>
<div class="number-picker" id="numberPicker">
    <div class="number-grid">
        <button class="number-btn" onclick="selectNumber(1)">1</button>
        <button class="number-btn" onclick="selectNumber(2)">2</button>
        <button class="number-btn" onclick="selectNumber(3)">3</button>
        <button class="number-btn" onclick="selectNumber(4)">4</button>
        <button class="number-btn" onclick="selectNumber(5)">5</button>
        <button class="number-btn" onclick="selectNumber(6)">6</button>
        <button class="number-btn" onclick="selectNumber(7)">7</button>
        <button class="number-btn" onclick="selectNumber(8)">8</button>
        <button class="number-btn" onclick="selectNumber(9)">9</button>
        <button class="number-btn" onclick="selectNumber(0)">0</button>
    </div>
    <button class="close-picker-btn" onclick="closePicker()">取消</button>
</div>

<script>
    let gameState = {
        isPlaying: false,
        timeLeft: 60,
        score: 0,
        timerId: null,
        currentProblem: {},
        userAnswer: { tens: null, ones: null },
        isBorrowed: false,
        activeField: null 
    };

    const els = {
        timer: document.getElementById('timer'),
        score: document.getElementById('score'),
        mask: document.getElementById('problemMask'),
        startBtn: document.getElementById('startBtn'),
        nextBtn: document.getElementById('nextBtn'),
        feedback: document.getElementById('feedback'),
        overlay: document.getElementById('overlay'),
        picker: document.getElementById('numberPicker'),
        mTens: document.getElementById('minuend-tens'),
        mOnes: document.getElementById('minuend-ones'),
        sTens: document.getElementById('subtrahend-tens'),
        sOnes: document.getElementById('subtrahend-ones'),
        aTens: document.getElementById('answer-tens'),
        aOnes: document.getElementById('answer-ones'),
        borrowLeftVal: document.getElementById('borrow-left-val'),
        borrowOnesInd: document.getElementById('borrow-ones-indicator')
    };

    function init() {
        generateProblem();
    }

    function generateProblem() {
        let min, sub;
        const forceBorrow = Math.random() > 0.5;

        do {
            min = Math.floor(Math.random() * 90) + 10; 
            sub = Math.floor(Math.random() * 90) + 10; 
            
            let minOnes = min % 10;
            let subOnes = sub % 10;

            if (forceBorrow && minOnes >= subOnes) {
                continue; 
            }

        } while (min <= sub);

        gameState.currentProblem = {
            min: min,
            sub: sub,
            ans: min - sub
        };

        gameState.userAnswer = { tens: null, ones: null };
        gameState.isBorrowed = false;
        
        renderProblem();
        resetAnswerStyles();
        els.feedback.textContent = "";
        
        if (gameState.isPlaying) {
            els.nextBtn.style.display = 'block';
        }
    }

    function renderProblem() {
        const p = gameState.currentProblem;
        const mStr = p.min.toString();
        const sStr = p.sub.toString().padStart(2, '0'); 

        els.mTens.textContent = mStr.length === 2 ? mStr[0] : '';
        els.mOnes.textContent = mStr.length === 2 ? mStr[1] : mStr[0];
        
        if (mStr.length === 2) {
            els.borrowLeftVal.textContent = parseInt(mStr[0]) - 1;
        } else {
             els.borrowLeftVal.textContent = "";
        }

        els.sTens.textContent = sStr[0] === '0' ? '' : sStr[0];
        els.sOnes.textContent = sStr[1];

        els.mTens.classList.remove('borrowed');
        els.borrowLeftVal.classList.remove('show');
        els.borrowOnesInd.classList.remove('show');
    }

    function startGame() {
        if (gameState.isPlaying) return;

        gameState.score = 0;
        gameState.timeLeft = 60;
        gameState.isPlaying = true;
        
        els.score.textContent = `答對: 0`;
        els.timer.textContent = `時間: 60秒`;
        els.startBtn.style.display = 'none'; 
        els.nextBtn.style.display = 'block'; 
        els.mask.style.display = 'none'; 

        generateProblem();

        gameState.timerId = setInterval(() => {
            gameState.timeLeft--;
            els.timer.textContent = `時間: ${gameState.timeLeft}秒`;
            
            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    function endGame() {
        clearInterval(gameState.timerId);
        gameState.isPlaying = false;
        
        els.mask.style.display = 'flex';
        els.mask.innerHTML = `
            <div style="color: #e74c3c; font-size: 32px; margin-bottom: 10px;">時間到！</div>
            <div style="color: #2c3e50;">總共答對：${gameState.score} 題</div>
            <div style="font-size: 14px; margin-top: 5px;">請按下重新開始</div>
        `;

        els.startBtn.textContent = "重新開始";
        els.startBtn.style.display = 'block';
        els.nextBtn.style.display = 'none';
        els.timer.textContent = "時間: 0秒";
    }

    function nextQuestion() {
        if (!gameState.isPlaying) return;
        generateProblem();
    }

    function toggleBorrow() {
        if (!gameState.isPlaying) return;
        if (gameState.currentProblem.min < 10) return;

        gameState.isBorrowed = !gameState.isBorrowed;

        if (gameState.isBorrowed) {
            els.mTens.classList.add('borrowed');
            els.borrowLeftVal.classList.add('show');
            els.borrowOnesInd.classList.add('show');
        } else {
            els.mTens.classList.remove('borrowed');
            els.borrowLeftVal.classList.remove('show');
            els.borrowOnesInd.classList.remove('show');
        }
    }

    function openPicker(field) {
        if (!gameState.isPlaying) return;
        gameState.activeField = field;
        els.overlay.style.display = 'block';
        els.picker.style.display = 'block';
    }

    function closePicker() {
        els.overlay.style.display = 'none';
        els.picker.style.display = 'none';
        gameState.activeField = null;
    }

    function selectNumber(num) {
        if (!gameState.activeField) return;

        const field = gameState.activeField;
        gameState.userAnswer[field] = num;

        const box = field === 'tens' ? els.aTens : els.aOnes;
        box.textContent = num;
        box.classList.add('filled');

        closePicker();
        checkAnswer();
    }

    function checkAnswer() {
        const { tens, ones } = gameState.userAnswer;
        const realAns = gameState.currentProblem.ans;
        const realTens = Math.floor(realAns / 10);
        
        let userTens = tens === null ? 0 : tens;
        let userOnes = ones === null ? -1 : ones;

        if (userOnes === -1) return;
        if (realTens > 0 && tens === null) return;

        const userVal = userTens * 10 + userOnes;

        if (userVal === realAns) {
            els.feedback.textContent = "太棒了！答對了！";
            els.feedback.style.color = "rgb(76, 175, 80)";
            
            if (tens !== null) els.aTens.classList.add('correct-answer');
            els.aOnes.classList.add('correct-answer');

            gameState.score++;
            els.score.textContent = `答對: ${gameState.score}`;

            setTimeout(() => {
                if (gameState.isPlaying) {
                    generateProblem();
                }
            }, 1000);

        } else {
            if ( (tens !== null || realTens === 0) && ones !== null) {
                els.feedback.textContent = "再試試看喔！";
                els.feedback.style.color = "rgb(244, 67, 54)";
                els.aOnes.classList.add('wrong-answer');
                if (tens !== null) els.aTens.classList.add('wrong-answer');
                
                setTimeout(() => {
                    els.aOnes.classList.remove('wrong-answer');
                    els.aTens.classList.remove('wrong-answer');
                }, 1000);
            }
        }
    }

    function resetAnswerStyles() {
        els.aTens.textContent = "?";
        els.aOnes.textContent = "?";
        els.aTens.classList.remove('filled', 'correct-answer', 'wrong-answer');
        els.aOnes.classList.remove('filled', 'correct-answer', 'wrong-answer');
    }

    init();
</script>

</body>
</html>