import React, { useState, useEffect, useRef } from 'react';
import { Trophy, RefreshCcw } from 'lucide-react';

const TugOfWarMath = () => {
  // éŠæˆ²å¸¸æ•¸
  const GOAL_DIFFERENCE = 6; // æ·¨å‹å¹¾é¡Œç²å‹
  const ELEPHANT_OFFSET = 160; // å¤§è±¡è·é›¢ä¸­å¿ƒçš„åƒç´ è·é›¢
  const DELAY_MS = 2000; // ç­”å°å¾Œåœç•™è±ªç§’æ•¸
  
  // ç‹€æ…‹ç®¡ç†
  const [score, setScore] = useState(0); // æ­£æ•¸ä»£è¡¨å³é‚Šè´çš„é¡Œæ•¸ï¼Œè² æ•¸ä»£è¡¨å·¦é‚Šè´çš„é¡Œæ•¸
  const [winner, setWinner] = useState(null); // 'left' | 'right' | null
  const [isResetting, setIsResetting] = useState(false); // æ–°å¢ï¼šç”¨ä¾†æ§åˆ¶é‡ç½®æ™‚çš„å‹•ç•«ç‹€æ…‹
  
  // é¡Œç›®ç‹€æ…‹ (å¢åŠ  isCorrect ç”¨ä¾†é–å®šè¼¸å…¥ä¸¦é¡¯ç¤ºç¶ è‰²)
  const [leftProblem, setLeftProblem] = useState({ n1: 0, n2: 0, ans: 0, inputTen: '', inputUnit: '', isCorrect: false });
  const [rightProblem, setRightProblem] = useState({ n1: 0, n2: 0, ans: 0, inputTen: '', inputUnit: '', isCorrect: false });

  // éµç›¤æ§åˆ¶ç‹€æ…‹
  const [activeKeypad, setActiveKeypad] = useState(null);

  // Timer Ref (ç”¨ä¾†åœ¨é‡ç½®æ™‚æ¸…é™¤æœªå®Œæˆçš„å»¶é²)
  const leftTimerRef = useRef(null);
  const rightTimerRef = useRef(null);

  // åˆå§‹åŒ–é¡Œç›®
  const generateProblem = () => {
    const n1 = Math.floor(Math.random() * 80) + 10;
    const n2 = Math.floor(Math.random() * 9) + 1;
    return {
      n1,
      n2,
      ans: n1 + n2,
      inputTen: '', 
      inputUnit: '',
      isCorrect: false
    };
  };

  // éŠæˆ²é–‹å§‹/é‡ç½®
  useEffect(() => {
    resetGame();
    return () => {
      if (leftTimerRef.current) clearTimeout(leftTimerRef.current);
      if (rightTimerRef.current) clearTimeout(rightTimerRef.current);
    };
  }, []);

  const resetGame = () => {
    // 1. æ¨™è¨˜æ­£åœ¨é‡ç½® (ç”¨ä¾†æš«æ™‚é—œé–‰å‹•ç•«)
    setIsResetting(true);

    // æ¸…é™¤æ‰€æœ‰å»¶é²ä¸­çš„ä¸‹ä¸€é¡Œå‹•ä½œ
    if (leftTimerRef.current) clearTimeout(leftTimerRef.current);
    if (rightTimerRef.current) clearTimeout(rightTimerRef.current);

    // 2. é‡ç½®æ‰€æœ‰æ•¸å€¼
    setScore(0);
    setWinner(null);
    setLeftProblem(generateProblem());
    setRightProblem(generateProblem());
    setActiveKeypad(null);

    // 3. çŸ­æš«å»¶é²å¾Œæ¢å¾©å‹•ç•«æ•ˆæœ (è®“ç•«é¢æœ‰æ™‚é–“ç¬é–“è·³å›åŸé»)
    setTimeout(() => {
      setIsResetting(false);
    }, 50);
  };

  // è™•ç†æ•¸å­—è¼¸å…¥
  const handleNumClick = (num) => {
    if (!activeKeypad || winner) return;

    const { side, digit } = activeKeypad;
    
    // æª¢æŸ¥è©²é‚Šæ˜¯å¦è™•æ–¼ã€Œç­”å°åœç•™ä¸­ã€ï¼Œå¦‚æœæ˜¯å‰‡ä¸å…è¨±ä¿®æ”¹
    if (side === 'left' && leftProblem.isCorrect) return;
    if (side === 'right' && rightProblem.isCorrect) return;

    // æ›´æ–°å°æ‡‰é‚Šçš„é¡Œç›®è¼¸å…¥
    if (side === 'left') {
      const newProb = { ...leftProblem };
      if (digit === 'ten') newProb.inputTen = num;
      else newProb.inputUnit = num;
      setLeftProblem(newProb);
      checkAnswer('left', newProb);
    } else {
      const newProb = { ...rightProblem };
      if (digit === 'ten') newProb.inputTen = num;
      else newProb.inputUnit = num;
      setRightProblem(newProb);
      checkAnswer('right', newProb);
    }

    // é—œé–‰éµç›¤
    setActiveKeypad(null);
  };

  // æª¢æŸ¥ç­”æ¡ˆ
  const checkAnswer = (side, problem) => {
    const { inputTen, inputUnit, ans } = problem;
    
    if (inputTen === '' || inputUnit === '') return;

    const userAnswer = parseInt(`${inputTen}${inputUnit}`);

    if (userAnswer === ans) {
      handleCorrectAnswer(side);
    }
  };

  const handleCorrectAnswer = (side) => {
    // 1. æ›´æ–°åˆ†æ•¸èˆ‡æª¢æŸ¥ç²å‹
    let newScore = score;
    let isGameOver = false;

    if (side === 'right') {
      newScore += 1;
    } else {
      newScore -= 1;
    }
    setScore(newScore);

    if (newScore >= GOAL_DIFFERENCE) {
      setWinner('right');
      isGameOver = true;
    } else if (newScore <= -GOAL_DIFFERENCE) {
      setWinner('left');
      isGameOver = true;
    }

    // 2. è¨­å®šè©²é‚Šç‹€æ…‹ç‚ºã€Œæ­£ç¢ºã€(é–å®šè¼¸å…¥ã€è®Šç¶ è‰²)
    if (side === 'right') {
      setRightProblem(prev => ({ ...prev, isCorrect: true }));
    } else {
      setLeftProblem(prev => ({ ...prev, isCorrect: true }));
    }

    // 3. å¦‚æœéŠæˆ²æ²’çµæŸï¼Œè¨­å®š 2 ç§’å¾Œå‡ºä¸‹ä¸€é¡Œ
    if (!isGameOver) {
      if (side === 'right') {
        if (rightTimerRef.current) clearTimeout(rightTimerRef.current);
        rightTimerRef.current = setTimeout(() => {
          setRightProblem(generateProblem());
        }, DELAY_MS);
      } else {
        if (leftTimerRef.current) clearTimeout(leftTimerRef.current);
        leftTimerRef.current = setTimeout(() => {
          setLeftProblem(generateProblem());
        }, DELAY_MS);
      }
    }
  };

  return (
    <div className="min-h-screen bg-amber-50 font-sans select-none overflow-hidden flex flex-col">
      
      {/* æ¨™é¡Œåˆ— */}
      <div className="bg-white shadow-sm p-3 text-center relative z-20 shrink-0">
        <h1 className="text-xl md:text-2xl font-bold text-gray-700 flex items-center justify-center gap-2">
          <span>ğŸ‹ï¸</span> æ•¸å­¸æ‹”æ²³å¤§è³½ <span>ğŸ‹ï¸</span>
        </h1>
        <div className="text-xs md:text-sm text-gray-500 mt-1">èª°å…ˆé ˜å…ˆ {GOAL_DIFFERENCE} é¡Œå°±ç²å‹ï¼</div>
      </div>

      {/* ç¨ç«‹çš„æ‹”æ²³å‹•ç•«å€ */}
      <div className="h-40 relative w-full bg-sky-100/30 border-b-4 border-amber-200/50 overflow-hidden shrink-0 z-10">
          {/* åœ°æ¿ç·š */}
          <div className="w-full h-2 bg-amber-800/20 absolute bottom-4 left-0"></div>
          
          {/* ä¸­å¿ƒæ¨™è¨˜ */}
          <div className="absolute top-0 bottom-4 left-1/2 w-0.5 bg-red-400/50 transform -translate-x-1/2 z-0"></div>
          <div className="absolute bottom-4 left-1/2 w-2 h-6 bg-red-300 transform -translate-x-1/2 z-0"></div>
          
          {/* ç¹©å­èˆ‡å¤§åŠ›å£«å®¹å™¨ */}
          {/* æ³¨æ„ï¼šé€™è£¡åŠ å…¥äº† isResetting åˆ¤æ–·ï¼Œå¦‚æœæ­£åœ¨é‡ç½®ï¼Œå°±ç§»é™¤ transition-allï¼Œè®“å®ƒç¬é–“æ­¸ä½ */}
          <div 
            className={`absolute bottom-8 left-1/2 w-0 h-24 ${isResetting ? '' : 'transition-all duration-700 ease-in-out'}`}
            style={{ 
              transform: `translateX(calc(-50% + ${(score * (ELEPHANT_OFFSET / GOAL_DIFFERENCE))}px))` 
            }} 
          >
            <div className="absolute top-1/2 left-[-400px] right-[-400px] h-3 bg-amber-700 rounded-full shadow-sm w-[800px]"></div>
            
            <div className="absolute top-1/2 left-1/2 w-8 h-8 bg-red-500 rounded-full border-4 border-white transform -translate-x-1/2 -translate-y-1/2 shadow-md z-10"></div>

            {/* å·¦é‚Šå¤§åŠ›å£« (å¤§è±¡) - é–å®š scaleX(-1) é¢å‘å³/ä¸­é–“ */}
            <div 
              className="absolute top-1/2 text-6xl filter drop-shadow-lg animate-bounce-slow flex items-center justify-center"
              style={{ 
                left: '50%', 
                marginLeft: `-${ELEPHANT_OFFSET}px`,
                transform: 'translate(-50%, -50%) scaleX(-1)' 
              }}
            >
              ğŸ˜
            </div>

            {/* å³é‚Šå¤§åŠ›å£« (å¤§è±¡) - é–å®š scaleX(1) é¢å‘å·¦/ä¸­é–“ */}
            <div 
              className="absolute top-1/2 text-6xl filter drop-shadow-lg animate-bounce-slow flex items-center justify-center"
              style={{ 
                left: '50%', 
                marginLeft: `${ELEPHANT_OFFSET}px`,
                transform: 'translate(-50%, -50%) scaleX(1)'
              }}
            >
              ğŸ˜
            </div>
          </div>
      </div>

      {/* ä¸»è¦éŠæˆ²å€ */}
      <div className="flex-1 flex flex-row relative overflow-hidden">
        
        {/* å·¦é‚Šç©å®¶å€å¡Š */}
        <div className={`flex-1 p-4 flex flex-col items-center justify-start pt-10 transition-colors duration-300 ${winner === 'left' ? 'bg-blue-100' : 'bg-blue-50'}`}>
          <div className={`bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm border-4 transition-all duration-300 ${leftProblem.isCorrect ? 'border-green-400 ring-4 ring-green-200' : 'border-blue-200'}`}>
            <h2 className="text-xl font-bold text-blue-500 mb-6 text-center">å·¦é‚Šå¤§è±¡éšŠ</h2>
            <div className="flex items-center justify-center gap-2 text-4xl md:text-5xl font-bold text-gray-700 mb-8">
              <span>{leftProblem.n1}</span>
              <span>+</span>
              <span>{leftProblem.n2}</span>
              <span>=</span>
            </div>
            
            <div className="flex gap-3 justify-center">
              <AnswerBox 
                val={leftProblem.inputTen} 
                onClick={() => !leftProblem.isCorrect && setActiveKeypad({ side: 'left', digit: 'ten' })}
                active={activeKeypad?.side === 'left' && activeKeypad?.digit === 'ten'}
                color="blue"
                isCorrect={leftProblem.isCorrect}
              />
              <AnswerBox 
                val={leftProblem.inputUnit} 
                onClick={() => !leftProblem.isCorrect && setActiveKeypad({ side: 'left', digit: 'unit' })}
                active={activeKeypad?.side === 'left' && activeKeypad?.digit === 'unit'}
                color="blue"
                isCorrect={leftProblem.isCorrect}
              />
            </div>
          </div>
        </div>

        {/* åˆ†éš”ç·š */}
        <div className="w-1 bg-gray-200 z-0"></div>

        {/* å³é‚Šç©å®¶å€å¡Š */}
        <div className={`flex-1 p-4 flex flex-col items-center justify-start pt-10 transition-colors duration-300 ${winner === 'right' ? 'bg-pink-100' : 'bg-pink-50'}`}>
          <div className={`bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm border-4 transition-all duration-300 ${rightProblem.isCorrect ? 'border-green-400 ring-4 ring-green-200' : 'border-pink-200 relative z-10'}`}>
            <h2 className="text-xl font-bold text-pink-500 mb-6 text-center">å³é‚Šå¤§è±¡éšŠ</h2>
            <div className="flex items-center justify-center gap-2 text-4xl md:text-5xl font-bold text-gray-700 mb-8">
              <span>{rightProblem.n1}</span>
              <span>+</span>
              <span>{rightProblem.n2}</span>
              <span>=</span>
            </div>
            
            <div className="flex gap-3 justify-center">
              <AnswerBox 
                val={rightProblem.inputTen} 
                onClick={() => !rightProblem.isCorrect && setActiveKeypad({ side: 'right', digit: 'ten' })}
                active={activeKeypad?.side === 'right' && activeKeypad?.digit === 'ten'}
                color="pink"
                isCorrect={rightProblem.isCorrect}
              />
              <AnswerBox 
                val={rightProblem.inputUnit} 
                onClick={() => !rightProblem.isCorrect && setActiveKeypad({ side: 'right', digit: 'unit' })}
                active={activeKeypad?.side === 'right' && activeKeypad?.digit === 'unit'}
                color="pink"
                isCorrect={rightProblem.isCorrect}
              />
            </div>
          </div>
        </div>
      </div>

      {/* æ•¸å­—éµç›¤ Modal */}
      {activeKeypad && (
        <div className="fixed inset-0 bg-black/20 flex items-end justify-center z-50 animate-fade-in" onClick={() => setActiveKeypad(null)}>
          <div className="bg-white p-4 rounded-t-2xl shadow-2xl w-full max-w-md mb-0 md:mb-10 md:rounded-2xl" onClick={e => e.stopPropagation()}>
            <div className="text-center text-gray-500 mb-2 font-medium">è«‹é¸æ“‡æ•¸å­—</div>
            <div className="grid grid-cols-5 gap-2">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map((num) => (
                <button
                  key={num}
                  onClick={() => handleNumClick(num)}
                  className={`
                    h-14 text-2xl font-bold rounded-lg shadow-sm transition-transform active:scale-95
                    ${activeKeypad.side === 'left' 
                      ? 'bg-blue-100 text-blue-700 hover:bg-blue-200 border-b-4 border-blue-300' 
                      : 'bg-pink-100 text-pink-700 hover:bg-pink-200 border-b-4 border-pink-300'}
                  `}
                >
                  {num}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* ç²å‹ç•«é¢ */}
      {winner && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
          <div className="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl transform scale-100 animate-pop-in">
            <div className="text-6xl mb-4 animate-bounce">
              ğŸ˜
            </div>
            <h2 className={`text-4xl font-black mb-2 ${winner === 'left' ? 'text-blue-500' : 'text-pink-500'}`}>
              {winner === 'left' ? 'å·¦é‚Šå¤§è±¡' : 'å³é‚Šå¤§è±¡'} ç²å‹ï¼
            </h2>
            <div className="flex justify-center mb-6">
               <Trophy className="w-16 h-16 text-yellow-400" />
            </div>
            <p className="text-gray-600 mb-8 text-lg">å¤ªå²å®³äº†ï¼è¦æŠŠå°æ–¹æ‹‰éä¾†å¯ä¸å®¹æ˜“å‘¢ï¼</p>
            <button 
              onClick={resetGame}
              className="w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold rounded-xl shadow-lg text-xl hover:from-yellow-500 hover:to-orange-600 transition-all flex items-center justify-center gap-2"
            >
              <RefreshCcw /> å†ç©ä¸€æ¬¡
            </button>
          </div>
        </div>
      )}
      
      <style>{`
        .animate-bounce-slow {
          animation: bounce 2s infinite;
        }
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .animate-fade-in {
          animation: fade-in 0.2s ease-out forwards;
        }
        @keyframes pop-in {
          0% { transform: scale(0.8); opacity: 0; }
          100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
          animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
      `}</style>
    </div>
  );
};

// è¼”åŠ©çµ„ä»¶ï¼šè¼¸å…¥æ–¹å¡Š
const AnswerBox = ({ val, onClick, active, color, isCorrect }) => {
  let baseClass = "w-16 h-20 border-4 rounded-xl flex items-center justify-center text-3xl font-bold cursor-pointer transition-all";
  
  // å¦‚æœç­”å°ï¼Œå¼·åˆ¶è®Šæˆç¶ è‰²æ¨£å¼
  if (isCorrect) {
    return (
      <div className={`${baseClass} border-green-500 bg-green-100 text-green-700`}>
        {val}
      </div>
    );
  }

  const colorClass = color === 'blue' 
    ? (active ? "border-blue-500 bg-blue-100 ring-4 ring-blue-200" : "border-blue-300 bg-white hover:bg-blue-50")
    : (active ? "border-pink-500 bg-pink-100 ring-4 ring-pink-200" : "border-pink-300 bg-white hover:bg-pink-50");
  
  return (
    <div className={`${baseClass} ${colorClass}`} onClick={onClick}>
      {val !== '' ? val : <span className="text-gray-300 text-2xl">?</span>}
    </div>
  );
};

export default TugOfWarMath;